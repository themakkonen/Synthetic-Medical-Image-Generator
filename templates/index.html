<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synthetic Medical Image Generator (MedMNIST)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f5f5f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            max-width: 800px;
        }
        .header {
            background: white;
            border-bottom: 2px solid #dee2e6;
            padding: 1rem 0;
            margin-bottom: 2rem;
        }
        .control-panel {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        .form-control, .form-select {
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 0.5rem 0.75rem;
        }
        .btn-generate {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            font-size: 1.1rem;
            border-radius: 4px;
            width: 100%;
        }
        .btn-generate:hover {
            background: #0056b3;
        }
        .results-section {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 2rem;
        }
        .status-badge {
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
        }
        .model-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .alert-warning {
            border-left: 4px solid #ffc107;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h2 class="text-center mb-0">Synthetic Medical Image Generator (MedMNIST)</h2>
            <p class="text-center text-muted mb-0">Using Your Trained GAN Models</p>
        </div>
    </div>

    <div class="container">
        <!-- System Status -->
        <div class="alert alert-info d-flex align-items-center">
            <div>
                <strong>System Status:</strong> 
                TensorFlow: <span class="badge {% if tf_available %}bg-success{% else %}bg-warning{% endif %} status-badge">
                    {% if tf_available %}Available{% else %}Not Available{% endif %}
                </span>
                Models: <span class="badge bg-primary status-badge">{{ models|length }} Found</span>
            </div>
        </div>

        {% if not tf_available %}
        <div class="alert alert-warning">
            <strong>⚠️ TensorFlow Not Available</strong><br>
            The app will use demo generation. To use your trained models, install TensorFlow properly.
        </div>
        {% endif %}

        <!-- Control Panel -->
        <div class="control-panel">
            <form id="generatorForm">
                <div class="row">
                    <!-- Dataset Selection -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Dataset:</label>
                            <select class="form-select" name="dataset" id="dataset">
                                {% for dataset, description in datasets.items() %}
                                <option value="{{ dataset }}">
                                    {{ dataset }}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted" id="datasetDescription">
                                Select training dataset
                            </small>
                        </div>
                    </div>

                    <!-- Model Selection -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">Model:</label>
                            <select class="form-select" name="model" id="model">
                                {% if models %}
                                    {% for model_key, model_info in models.items() %}
                                    <option value="{{ model_key }}">
                                        {{ model_info.name }}
                                    </option>
                                    {% endfor %}
                                {% else %}
                                    <option value="demo">Demo Model</option>
                                {% endif %}
                            </select>
                            <small class="form-text text-muted" id="modelDescription">
                                {{ first_model_desc }}
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Mode Selection -->
                <div class="form-group">
                    <label class="form-label">Mode:</label>
                    <div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="mode" id="generateScratch" value="scratch" checked>
                            <label class="form-check-label" for="generateScratch">
                                Generate from Scratch
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Number of Images -->
                <div class="form-group">
                    <label class="form-label">Number of Images:</label>
                    <input type="number" class="form-control" name="num_images" id="numImages" value="10" min="1" max="50">
                </div>

                <!-- Random Seed -->
                <div class="form-group">
                    <label class="form-label">Random Seed:</label>
                    <input type="number" class="form-control" name="seed" id="randomSeed" placeholder="Optional">
                    <small class="form-text text-muted">Leave empty for random generation</small>
                </div>

                <!-- Generate Button -->
                <div class="form-group">
                    <button type="submit" class="btn-generate" id="generateBtn">
                        Generate Images ▶
                    </button>
                </div>
            </form>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSection" class="text-center d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Generating...</span>
            </div>
            <p class="mt-2">Generating synthetic medical images...</p>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="results-section d-none">
            <h4 class="mb-3">Generated Images</h4>
            <div id="modelInfo" class="model-info"></div>
            <div id="imageResults"></div>
            <div class="text-center mt-3">
                <button id="downloadBtn" class="btn btn-outline-primary">
                    Download All Images
                </button>
            </div>
        </div>
    </div>

    <script>
        // Model descriptions
        const modelDescriptions = {
            {% if models %}
                {% for model_key, model_info in models.items() %}
                "{{ model_key }}": "{{ model_info.description }}",
                {% endfor %}
            {% else %}
                "demo": "Demo Generation Mode"
            {% endif %}
        };

        // Update model description
        document.getElementById('model').addEventListener('change', function() {
            const description = modelDescriptions[this.value] || 'Trained Model';
            document.getElementById('modelDescription').textContent = description;
        });

        // Form submission
        document.getElementById('generatorForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const dataset = formData.get('dataset');
            const model = formData.get('model');
            const numImages = formData.get('num_images');
            const seed = formData.get('seed');
            
            await generateImages(dataset, model, numImages, seed);
        });

        // Generate images
        async function generateImages(dataset, model, numImages, seed) {
            showLoading(true);
            hideResults();
            
            const formData = new FormData();
            formData.append('dataset', dataset);
            formData.append('model', model);
            formData.append('num_images', numImages);
            if (seed) {
                formData.append('seed', seed);
            }
            
            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayResults(data);
                } else {
                    alert('Error: ' + (data.error || 'Failed to generate images'));
                }
            } catch (error) {
                alert('Network error: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Display results
        function displayResults(data) {
            const resultsSection = document.getElementById('resultsSection');
            const imageResults = document.getElementById('imageResults');
            const modelInfo = document.getElementById('modelInfo');
            
            // Show model information
            modelInfo.innerHTML = `
                <strong>Model:</strong> ${data.model} (${data.model_description})<br>
                <strong>Dataset:</strong> ${data.dataset}<br>
                <strong>Images Generated:</strong> ${data.num_generated}<br>
                <strong>Seed:</strong> ${data.seed_used || 'Random'}<br>
                <strong>Mode:</strong> ${data.using_trained_model ? 'Trained Model' : 'Demo Generation'}
                ${!data.using_trained_model ? '<span class="badge bg-warning float-end">Demo</span>' : '<span class="badge bg-success float-end">Trained</span>'}
            `;
            
            // Show images
            if (data.num_generated > 1) {
                imageResults.innerHTML = `
                    <div class="text-center">
                        <img src="${data.grid}" alt="Generated images" class="img-fluid">
                    </div>
                `;
            } else {
                imageResults.innerHTML = `
                    <div class="text-center">
                        <img src="${data.images[0].data}" alt="Generated image" class="img-fluid" style="max-width: 300px;">
                    </div>
                `;
            }
            
            // Update download button
            document.getElementById('downloadBtn').onclick = () => downloadAllImages(data);
            
            resultsSection.classList.remove('d-none');
        }

        // Download all images
        async function downloadAllImages(data) {
            for (let i = 0; i < data.images.length; i++) {
                await downloadImage(i, data.dataset, data.model, data.seed_used);
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }

        // Download single image
        async function downloadImage(imageId, dataset, model, seed) {
            const formData = new FormData();
            formData.append('dataset', dataset);
            formData.append('model', model);
            if (seed) {
                formData.append('seed', seed);
            }
            
            try {
                const response = await fetch(`/download_image/${imageId}`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${dataset}_${model}_${imageId + 1}.png`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                }
            } catch (error) {
                console.error('Download error:', error);
            }
        }

        // UI functions
        function showLoading(show) {
            document.getElementById('loadingSection').classList.toggle('d-none', !show);
        }

        function hideResults() {
            document.getElementById('resultsSection').classList.add('d-none');
        }
    </script>
</body>
</html>